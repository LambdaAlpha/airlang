# 函数

函数类型表示一个函数。

## 模式函数

模式函数根据模式对输入进行变换。

模式函数用于提供灵活的解释代码的方式。

每种类型有三种模式：恒等模式，形式模式，求值模式。其等级顺序递增，当没有指定高等级模式的变换方式，默认和其低等级的变换方式相同。

### 恒等模式

恒等模式下，所有类型变换为自身。

### 形式模式

形式模式下，符号进行如下变换，其他所有类型进行结构性变换。

- `.a` 表示字面量 `a`
- `*a` 表示读取上下文中 `a` 的值
- `^a` 表示移动上下文中 `a` 的值
- `a` 根据模式的配置，可以表示以上三种语义中的一种

### 求值模式

求值模式下，符号变换同形式模式下，调用，抽象，询问按其语义变换。

### 类型的模式

#### 符号

符号变换见形式模式

#### 配对

形式模式：对第一个值应用一个模式，对第二个值应用另一个模式

#### 调用

形式模式：对函数应用一个模式，对输入应用另一个模式

求值模式：见[求值规则](../求值.md)

#### 抽象

形式模式：对函数应用一个模式，对输入应用另一个模式

求值模式：求值模式：见[求值规则](../求值.md)

#### 询问

形式模式：对函数应用一个模式，对输出应用另一个模式

求值模式：求值模式：见[求值规则](../求值.md)

#### 列表

形式模式：对列表的前一部分元素应用指定的模式，对剩余元素应用另一个模式

#### 映射

形式模式：对映射中的部分键的值应用指定的模式，对剩余键应用键的模式，对其值应用值的模式

### 基础模式

- `恒等模式`：不变换
- `形式模式`：递归应用值的类型的形式模式
- `求值模式`：递归应用值的类型的求值模式

### 组合模式

自由组合每个类型的模式。组合模式分为可递归和不可递归。

### 例子

- `eval*`：对任意值应用 `eval*`
- `{}`：非递归，对任意值应用默认模式（`eval*`）
- `{pair : form. : eval*}`：非递归，对配对的第一项应用 `form.`，对配对的第二项应用 `eval*`；对其他任何值应用默认模式
- `{symbol : id, recursive : true}`：递归，对符号应用 `id`；对其他类型都应用默认模式，对子项递归应用此模式
- `{pair : form. : self, recursive : true}`：递归，对配对的第一项应用 `form.`，对配对的第二项应用此模式；对其他任何值应用默认模式
- `{pair : form* : {symbol : id}, default : id}`：非递归，对配对的第一项应用 `form*`，对配对的第二项应用 `{symbol : id}`；对其他类型都应用默认模式（`id`）
- `{list : [form^, id] : eval.}` 非递归，对列表的第一项应用 `form^`，对第二项应用 `id`，对剩余其他项应用 `eval.`；对其他任何值应用默认模式
- `{map : {a : id, b : eval*} : form^ : id}`：非递归，对映射的以 `a` 为键的值应用 `id`，对以 `b` 为键的值应用 `eval*`，对任何其他项的键应用 `form^`，对其值应用 `id`；对其他任何值应用默认模式

## 静态函数和细胞函数

静态函数在被调用时会复制一份内上下文作为运行上下文，因此无法存续状态。

细胞函数在被调用时直接使用内上下文作为运行上下文，因此可以存续状态。

## 调用模式，抽象模式和询问模式

在求值模式中，调用（抽象，询问）时，会先调用函数的对应模式函数预处理参数。

模式函数的调用模式和抽象模式是恒等模式，询问模式是默认模式。

其他函数的默认的调用，抽象，询问模式都为求值模式。

## 函数体模式

函数体模式是用来对函数体进行变换的模式。

## 上下文访问

函数分为上下文无关函数，上下文不变函数和上下文可变函数。

### 无关

上下文无关函数不需要/不能访问上下文。

### 不变

上下文不变函数需要/能读取上下文，但不需要/不能改变上下文。

### 可变

上下文可变函数既需要/能读取上下文，也需要/能改变上下文。

## 实现方式

### 基础函数

基础函数由语言内置实现或第三方拓展实现。

可以区分基础函数是内置的还是拓展的。

#### 内置

内置基础函数内置于初始上下文中。

每个内置基础函数有一个唯一的标识符，其与初始上下文中此基础函数的键相同。

#### 拓展

每个拓展基础函数有一个唯一的标识符。拓展基础函数的标识符可以和内置的基础函数的标识符一样。

### 组合函数

组合函数是由其他函数组合而成的函数。组合函数由以下元素组成

- 函数体模式
- 函数体
- 内上下文
- 输入名
- 上下文名（上下文相关函数）

组合函数被调用时的行为如下

- 若函数是静态函数，其内上下文被复制一份作为运行上下文，若函数是细胞函数，使用其内上下文作为运行上下文
- 函数调用的输入以输入名为键存储至运行上下文中，无不变性
- 当函数为上下文可变/不变函数时，函数调用的上下文以上下文名为键存储至运行上下文中，其不变性为不可赋值/不可变，且为静态绑定
- 以运行上下文为上下文，以函数体为输入，调用求值函数，并返回其返回值

## 可缓存性

可缓存性：若函数 `f` 具有可缓存性，则以相同的上下文和输入再次调用 `f`，可以返回相同的输出，并且上下文的变化也相同。
