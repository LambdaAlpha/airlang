# 函数

函数类型表示一个函数。

## 模式函数

模式函数根据模式对输入进行变换。

模式函数用于提供灵活的解释代码的方式。

所有类型分为四种

- 符号类型：符号
- 形式类型：配对，变化，抽象，列表，映射
- 语义类型：调用，优化，解决
- 恒等类型：其他类型

| 模式\类型 |恒等类型|符号类型|形式类型|语义类型|
| -- | -- | -- | -- | -- |
|恒等模式|恒等变换|恒等变换|恒等变换|恒等变换|
|形式模式|恒等变换|符号变换|形式变换|形式变换|
|语义模式|恒等变换|符号变换|形式变换|语义变换|

### 变换

- 符号变换
  - `.a` 表示字面量 `a`
  - `*a` 表示读取上下文中 `a` 的值
  - `^a` 表示移动上下文中 `a` 的值
  - `a` 根据模式的配置，可以表示以上三种语义中的一种
- 恒等变换：变换为自身，即不变。
- 形式变换：结构性变换，即对其子结构进行变换。
- 语义变换：按其语义变换，见[求值规则](../求值.md)。

### 模式

以下模式可以应用于所有类型。

#### 恒等模式

对所有的类型应用恒等模式。

#### 统一模式

对所有的类型应用统一的模式。

#### 基础模式

对每个类型应用指定的模式，对形式类型和语义类型的子结构递归应用此模式。

#### 组合模式

对每个类型应用指定的模式，对形式类型和语义类型的子结构应用指定的模式。

- 配对：对第一个值应用一个模式，对第二个值应用另一个模式
- 调用：对函数应用一个模式，对输入应用另一个模式
- 优化：对函数应用一个模式，对输入应用另一个模式
- 解决：对函数应用一个模式，对输出应用另一个模式
- 抽象：对其值应用一个模式
- 列表：对列表的前一部分元素应用指定的模式，对剩余元素应用另一个模式
- 映射：对映射中的部分键的值应用指定的模式，对剩余键应用键的模式，对其值应用值的模式

#### 函数模式

函数模式通过函数进行变换。

函数模式提供了执行任意变换的能力。

### 例子

- `eval*`：对任意值应用 `eval*`
- `{}`：非递归，对任意值应用默认模式
- `{pair : form. : eval*}`：非递归，对配对的第一项应用 `form.`，对配对的第二项应用 `eval*`；对其他任何值应用默认模式
- `{symbol : id, primitive : true}`：递归，对符号应用 `id`；对其他类型都应用默认模式，对子项递归应用此模式
- `{call : form, primitive : true}`：递归，对调用的函数和输入分别应用此模式，然后对调用应用 `form` 模式；对其他任何值应用默认模式
- `{pair : form* : {symbol : id}, default : id}`：非递归，对配对的第一项应用 `form*`，对配对的第二项应用 `{symbol : id}`；对其他类型都应用默认模式（`id`）
- `{list : [form^, id] : eval.}` 非递归，对列表的第一项应用 `form^`，对第二项应用 `id`，对剩余其他项应用 `eval.`；对其他任何值应用默认模式
- `{map : {a : id, b : eval*} : form^ : id}`：非递归，对映射的以 `a` 为键的值应用 `id`，对以 `b` 为键的值应用 `eval*`，对任何其他项的键应用 `form^`，对其值应用 `id`；对其他任何值应用默认模式

## 静态函数和细胞函数

静态函数在被调用时会复制一份内上下文作为运行上下文，因此无法存续状态。

细胞函数在被调用时直接使用内上下文作为运行上下文，因此可以存续状态。

## 调用模式，优化模式和解决模式

在求值模式中，调用（优化，解决）时，会先调用函数的对应模式函数预处理参数。

模式函数的调用模式和优化模式是恒等模式，解决模式是默认模式。

其他函数的默认的调用，优化，解决模式都为求值模式。

## 上下文访问

函数分为上下文无关函数，上下文不变函数和上下文可变函数。

### 无关

上下文无关函数不需要/不能访问上下文。

### 不变

上下文不变函数需要/能读取上下文，但不需要/不能改变上下文。

### 可变

上下文可变函数既需要/能读取上下文，也需要/能改变上下文。

## 实现方式

### 基础函数

基础函数由语言内置实现或第三方拓展实现。

可以区分基础函数是内置的还是拓展的。

#### 内置

内置基础函数内置于初始上下文中。

每个内置基础函数有一个唯一的标识符，其与初始上下文中此基础函数的键相同。

#### 拓展

每个拓展基础函数有一个唯一的标识符。拓展基础函数的标识符可以和内置的基础函数的标识符一样。

### 组合函数

组合函数是由其他函数组合而成的函数。组合函数由以下元素组成

- 调用过程
  - 上下文名（上下文相关函数）
  - 输入名
  - 函数体
- 内上下文

组合函数被调用时的行为如下

- 若函数是静态函数，其内上下文被复制一份作为运行上下文，若函数是细胞函数，使用其内上下文作为运行上下文
- 函数调用的输入以输入名为键存储至运行上下文中，变量访问类型为可赋值
- 当函数为上下文可变/不变函数时，函数调用的上下文以上下文名为键存储至运行上下文中，其变量访问类型为可变/不变，且为静态绑定
- 以运行上下文为上下文，以函数体为输入，调用求值函数，并返回其返回值

## 可缓存性

可缓存性：若函数 `f` 具有可缓存性，则以相同的上下文和输入再次调用 `f`，可以返回相同的输出，并且上下文的变化也相同。
