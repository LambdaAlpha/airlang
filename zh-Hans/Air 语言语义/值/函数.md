# 函数

函数类型表示一个函数。

## 输入预处理模式

函数的输入预处理模式用于调用函数时，预处理输入，将结果作为函数真正的输入。

输入预处理模式由匹配模式和预处理模式构成。若输入匹配函数的匹配模式，则应用对应的预处理模式，否则应用求值模式。

### 匹配模式

- `任意(预处理模式)`：匹配任意类型的值，应用指定预处理模式。
- `符号(预处理模式)`：匹配符号，应用指定预处理模式。
- `配对(匹配模式, 匹配模式)`：匹配配对，递归匹配。
- `调用(匹配模式, 匹配模式)`：匹配调用，递归匹配。
- `逆向(匹配模式, 匹配模式)`：匹配逆向，递归匹配。
- `列表(预处理模式)`：匹配列表，应用指定预处理模式。
- `列表递归(匹配模式)`：匹配列表，递归匹配所有元素。
- `列表元素([匹配模式或省略模式])`：匹配列表，递归匹配部分元素。列表元素有一种特殊的匹配模式，称为省略模式，用于列表剩余长度大于匹配模式列表剩余长度时，对一段连续的元素都应用相同的匹配模式，直到列表剩余长度和匹配模式剩余长度相等。
- `映射(预处理模式)`：匹配映射，应用指定预处理模式。
- `映射递归(匹配模式, 匹配模式)`：匹配映射，递归匹配。
- `映射元素({键 : 匹配模式})`：匹配映射，递归匹配部分元素。不对映射的键求值。

### 预处理模式

- `求值模式`：用求值函数对输入求值
- `值模式`：不对输入求值
- `引用模式`：
  - `'t a` 对 `a` 求值
  - `'f a` 不对 `a` 求值
  - 复合值递归应用引用模式
  - 其他值不求值

### 例子

- `任意(求值)`：对任意输入求值
- `符号(值)`：不对符号求值；对其他任何输入求值
- `配对(符号(值), 任意(求值))`：对配对的第一项应用 `符号(值)`，对配对的第二项应用 `任意(求值)`；对其他任何输入求值
- `列表(值)`：不对列表求值；对其他任何输入求值
- `列表递归(符号(值))`：对列表的每一个元素应用 `符号(值)`；对其他任何输入求值
- `列表元素([符号(值), 任意(值), 省略(任意(求值)), 任意(值)])`：对列表的第一项应用 `符号(值)`，对第二项应用 `任意(值)`，对第三项至倒数第二项应用 `任意(求值)`，对最后一项应用 `任意(值)`；对其他任何输入求值
- `映射(值)`：不对映射求值；对其他任何输入求值
- `映射递归(任意(引用), 任意(求值))`：对映射的每一个元素的键应用 `任意(引用)`，对映射的每一个元素的值应用 `任意(求值)`；对其他任何输入求值
- `映射元素({a : 任意(值), b : 任意(求值)})`：对映射的以 `a` 为键的值应用 `任意(值)`，对以 `b` 为键的值应用 `任意(求值)`，不对映射的其他键求值，对映射的其他键的值求值；对其他任何输入求值

## 上下文访问模式

函数根据其上下文访问模式分为上下文无关函数，上下文不变函数和上下文可变函数。

### 无关模式

上下文无关函数不需要/不能访问上下文。

### 不变模式

上下文不变函数需要/能读取上下文，但不需要/不能改变上下文。

### 可变模式

上下文可变函数既需要/能读取上下文，也需要/能改变上下文。

## 实现方式

### 基础函数

基础函数由语言实现，内置于初始上下文中。每个基础函数有一个唯一的标识符，其与初始上下文中此基础函数的键相同。

### 组合函数

组合函数是由其他函数组合而成的函数。组合函数有一个函数体，一个内置上下文，一个输入名。当函数为上下文可变/不变函数时，还有一个上下文名。

函数体是一个值。输入名和上下文名是符号。

组合函数被调用时的行为如下

- 其内置上下文被复制一份作为运行上下文

- 函数调用的输入以输入名为键存储至运行上下文中，无不变性

- 当函数为上下文可变/不变函数时，函数调用的上下文以上下文名为键存储至运行上下文中，其不变性为不可赋值/不可变

- 以运行上下文为上下文，以函数体为输入，调用求值函数，并返回其返回值
