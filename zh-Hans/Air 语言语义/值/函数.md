# 函数

函数类型表示一个函数。

## 变换模式

函数的调用（询问）变换模式用于调用（询问）函数时，预处理输入（输出），将结果作为函数真正的输入（输出）。

默认的调用（询问）变换模式为求值变换模式。

### 基础变换

- `恒等变换`：不变换
- `形式变换`
  - 符号变换
  - 复合值递归应用形式变换
- `求值变换`
  - 符号变换
  - 调用，询问，注释按[求值规则](../求值.md)变换
  - 其他复合值递归应用求值变换

符号变换

- `.a` 表示 `a`
- `$a` 表示读取上下文中 `a` 的值
- `&a` 表示移动上下文中 `a` 的值

### 结构变换

- 配对：对第一个值应用一个模式，对第二个值应用另一个模式
- 列表：对列表的前一部分元素应用指定的模式，对剩余元素应用另一个模式
- 映射：对映射中的部分键的值应用指定的模式，对剩余键的值应用另一个模式

### 例子

- `eval`：对任意值求值
- `{}`：对任意值求值
- `{pair : form : eval}`：对配对的第一项应用 `form`，对配对的第二项应用 `eval`；对其他任何值求值
- `{list : [] : form}`：对列表的每一个元素应用 `form`；对其他任何值求值
- `{list : [form, id] : eval}` 对列表的第一项应用 `form`，对第二项应用 `id`，对剩余其他项应用 `eval`；对其他任何值求值
- `{map : {a : id, b : eval} : form : id}`：对映射的以 `a` 为键的值应用 `id`，对以 `b` 为键的值应用 `eval`，对任何其他项的键应用 `form`，对其值应用 `id`；对其他任何值求值
- `{list : [] : form, default : form}`：对列表的每一个元素应用 `form`；对其他任何值应用 `form`

## 上下文访问模式

函数根据其上下文访问模式分为上下文无关函数，上下文不变函数和上下文可变函数。

### 无关模式

上下文无关函数不需要/不能访问上下文。

### 不变模式

上下文不变函数需要/能读取上下文，但不需要/不能改变上下文。

### 可变模式

上下文可变函数既需要/能读取上下文，也需要/能改变上下文。

## 静态函数

静态函数自身没有状态，非静态函数自身拥有状态。

上下文相关函数都是静态函数。上下文无关函数可以是非静态函数。

## 实现方式

### 基础函数

基础函数由语言内置实现或第三方拓展实现。

可以区分基础函数是内置的还是拓展的。

#### 内置

内置基础函数内置于初始上下文中。

每个内置基础函数有一个唯一的标识符，其与初始上下文中此基础函数的键相同。

#### 拓展

每个拓展基础函数有一个唯一的标识符。拓展基础函数的标识符可以和内置的基础函数的标识符一样。

### 组合函数

组合函数是由其他函数组合而成的函数。组合函数有一个函数体，一个内置上下文，一个输入名。当函数为上下文可变/不变函数时，还有一个上下文名。

函数体是一个值。输入名和上下文名是符号。

组合函数被调用时的行为如下

- 若函数是静态函数，其内上下文被复制一份作为运行上下文，否则使用其内上下文作为运行上下文
- 函数调用的输入以输入名为键存储至运行上下文中，无不变性
- 当函数为上下文可变/不变函数时，函数调用的上下文以上下文名为键存储至运行上下文中，其不变性为不可赋值/不可变
- 以运行上下文为上下文，以函数体为输入，调用求值函数，并返回其返回值

## 可缓存性

可缓存性：若函数 `f` 具有可缓存性，则以相同的上下文和输入再次调用 `f`，可以返回相同的输出，并且上下文的变化也相同。
